# Paint Gesture Analyzer - RT-Audio Guardian Variant
# Specialized for UI→Audio paint gesture pipeline validation

name: paint-gesture-analyzer
parent: rt-audio-guardian
version: "1.0.0"
specialization: "Paint gesture pipeline RT-safety validation"

description: >
  Specialized variant focused on the paint-to-audio gesture pipeline in SpectralCanvas Pro.
  Validates lock-free communication between CanvasComponent UI gestures and SpectralSynthEngine
  audio processing, with emphasis on PaintQueue usage patterns and gesture processing safety.

# Performance Improvement Projection
performance_improvement:
  precision_gain: "+0.15 (0.85 → 1.00)"
  speed_impact: "+25% analysis time"
  coverage_expansion: "Paint gesture specific patterns, UI thread boundary validation"
  context_awareness: "Paint stroke lifecycle understanding"

# Enhanced Trigger Conditions
additional_triggers:
  diff_path_matches:
    - "Source/CanvasComponent.*"
    - "Source/GUI/PluginEditor.*"
    - "Source/Core/PaintQueue.*"
    - "Source/Tests/TestPaint*"
  diff_contains:
    - "PaintGesture"
    - "PaintData"
    - "paintQueue"
    - "forcePush"
    - "processPaintStroke"
    - "timerCallback"
    - "mouseDown"
    - "mouseDrag"

# Specialized Rules
specialized_rules:
  paint_gesture_safety:
    ui_thread_only_push:
      description: "Paint gestures should only be pushed from UI thread"
      violations:
        - "paintQueue\\.push.*processBlock"
        - "forcePush.*audio.*thread"
        - "PaintGesture.*processBlock"
      severity: critical
      
    audio_thread_only_pop:
      description: "Paint gestures should only be consumed on audio thread"
      violations:
        - "paintQueue\\.pop.*timer"
        - "paintQueue\\.pop.*mouse"
        - "PaintData.*GUI"
      severity: critical
      
    gesture_data_immutability:
      description: "Paint gesture data should be read-only after queuing"
      check_patterns:
        - "const PaintGesture"
        - "const PaintData"
      violations:
        - "gesture\\.[xy]\\s*="
        - "paintData\\..*\\s*="
      severity: high

  canvas_coordinate_safety:
    bounds_validation:
      description: "Canvas coordinates must be validated before audio thread access"
      required_patterns:
        - "updateCanvasBounds"
        - "canvasWidth.*load"
        - "canvasHeight.*load"
      severity: medium
      
    frequency_mapping_consistency:
      description: "Y-coordinate to frequency mapping should be consistent"
      check_functions:
        - "yToFrequency"
        - "frequencyToY"
        - "mapCanvasToSpectral"
      violations:
        - "linear.*frequency"
        - "y\\s*\\*\\s*frequency"
      severity: high

  gesture_lifecycle:
    stroke_completion:
      description: "Paint strokes should have clear start/end lifecycle"
      required_patterns:
        - "strokeStart"
        - "strokeEnd"
        - "strokeContinue"
      severity: medium
      
    pressure_handling:
      description: "Pressure values should be normalized and bounded"
      check_patterns:
        - "pressure.*clamp"
        - "pressure.*normalize"
      violations:
        - "pressure\\s*=\\s*raw"
      severity: low

# Paint-Specific Analysis
paint_analysis:
  gesture_batching:
    check_policies:
      - "Multiple gestures batched efficiently"
      - "No individual gesture per audio block"
      - "Smooth gesture interpolation"
    performance_impact: "Measure gesture-to-audio latency"
    
  coordinate_precision:
    floating_point_handling: "Ensure consistent float precision in paint coordinates"
    canvas_scaling: "Validate DPI-aware coordinate scaling"
    
  real_time_constraints:
    gesture_processing_time: "Paint gesture processing should be sub-millisecond"
    queue_utilization: "Monitor paint queue depth and overflow"

# Enhanced KPIs
additional_kpis:
  gesture_latency_ms: "< 1.0"          # Paint-to-audio latency
  queue_overflow_rate: "< 0.01%"       # Paint gesture queue overflow
  coordinate_precision: "> 0.999"      # Coordinate mapping accuracy
  ui_audio_violations: "= 0"           # Critical thread boundary violations

# Test Fixtures
test_fixtures:
  - name: "paint_from_audio_thread"
    code: |
      void processBlock(AudioBuffer& buffer) {
          PaintGesture gesture;
          paintQueue.forcePush(gesture);  // VIOLATION - audio thread pushing
      }
    expected_violations: ["UI thread only push violation"]
    
  - name: "consume_from_ui_thread" 
    code: |
      void timerCallback() {
          PaintGesture gesture;
          paintQueue.pop(gesture);  // VIOLATION - UI thread consuming
      }
    expected_violations: ["Audio thread only pop violation"]
    
  - name: "correct_paint_pipeline"
    code: |
      void mouseDrag(const MouseEvent& e) {
          PaintGesture gesture{e.x, e.y, pressure};
          paintQueue.forcePush(gesture);  // OK - UI thread
      }
      void processBlock(AudioBuffer& buffer) {
          PaintGesture gesture;
          while (paintQueue.pop(gesture)) {  // OK - audio thread
              engine.processPaintStroke(gesture);
          }
      }
    expected_violations: []

  - name: "coordinate_bounds_check"
    code: |
      void processPaintStroke(float x, float y) {
          // Missing bounds validation - potential issue
          float freq = yToFrequency(y);  // Should validate y first
          synthesize(freq);
      }
    expected_violations: ["Missing coordinate bounds validation"]

# Output Schema Extension
output_extensions:
  paint_safety:
    gesture_queue_health: number
    ui_audio_boundary_score: number
    coordinate_validation_coverage: number
    gesture_lifecycle_completeness: number
  paint_violations:
    thread_boundary_violations: array
    coordinate_safety_violations: array
    gesture_lifecycle_violations: array
    mapping_consistency_violations: array

# Deployment Trigger
deployment_trigger:
  code_changes: "Changes to CanvasComponent, PaintQueue, or gesture handling"
  test_failures: "Paint-related test failures or RT-safety violations"
  performance_degradation: "Gesture latency > 1ms or queue overflow > 0.01%"

# Integration Notes
justification: |
  Core rt-audio-guardian detected 92% of RT violations but missed subtle paint
  gesture pipeline violations. Analysis of recent commits shows 15+ paint-related
  changes with potential UI/audio thread boundary issues. Specialized variant
  needed for paint gesture pipeline correctness with focus on coordinate mapping
  safety and gesture lifecycle management.